import{r as c,j as e,b as Ze}from"./vendor-react-BC0ZjSh6.js";import{g as et,D as Ue,j as Ve,B as z,k as qe,A as ye,C as Pe,E as fe,n as Ce,G as _e,c as P,e as Ae,d as ke,s as pe}from"./index-CaUs7y9b.js";import{a as ze,u as tt}from"./useMarketStatus-BXBgiSit.js";import{o as Te}from"./oi-profile-BLy94yOz.js";import{i as st,a1 as at,ae as rt,aT as nt,aU as lt,Y as Me,c as it,aB as ct,aD as ot}from"./vendor-icons-DX6bY0gC.js";import{D as Ye,a as dt,b as $e,c as Qe,d as We,e as ut,f as Xe,g as mt}from"./dialog-D-EocB5D.js";import{S as Le}from"./scroll-area-C6LKGir0.js";import{I as be}from"./input-D0eZ7ihf.js";import{L as le}from"./label-DCiiuQ14.js";import{S as oe,a as de,b as ue,c as me,d as xe}from"./select-CANpDY9y.js";import{t as Se}from"./trading-BjejzwMQ.js";import{C as xt,b as ht,a as pt}from"./collapsible-p16lzTl0.js";import{C as se,d as ae}from"./card-DpWxKhPV.js";import{T as ft,a as gt,b as we,c as ie,d as bt,e as ve}from"./table-Bv43iKQz.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-CQot2oyK.js";import"./vendor-radix-S2tz8W6K.js";function jt(s,t,l,a,o,d={enabled:!0,refreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:i,refreshInterval:h=3e4,pauseWhenHidden:j=!0}=d,{isVisible:C}=et(),[u,r]=c.useState({data:null,isLoading:!1,isConnected:!1,isPaused:!1,error:null,lastUpdate:null}),x=c.useRef(null),f=c.useRef(null),p=i&&(!j||C),I=c.useCallback(async()=>{if(!(!s||!t||!l||!a)&&!f.current){r(T=>({...T,isLoading:!0}));try{const T=new AbortController;f.current=T;const b=await fetch("/api/v1/optionchain",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apikey:s,underlying:t,exchange:l,expiry_date:a,strike_count:o}),signal:T.signal});if(!b.ok)throw new Error(`HTTP error! status: ${b.status}`);const m=await b.json();m.status==="success"?r(g=>({...g,data:m,isLoading:!1,isConnected:!0,error:null,lastUpdate:new Date})):r(g=>({...g,isLoading:!1,error:m.message||"Failed to fetch option chain"}))}catch(T){T instanceof Error&&(T.name==="AbortError"?f.current===null&&r(b=>({...b,isLoading:!1})):r(b=>({...b,isLoading:!1,error:T.message||"Connection error",isConnected:!1})))}finally{f.current=null}}},[s,t,l,a,o]);c.useEffect(()=>{if(!p){x.current&&(clearInterval(x.current),x.current=null),r(T=>({...T,isPaused:!!i}));return}return r(T=>({...T,isConnected:!0,isPaused:!1})),I(),x.current=setInterval(I,h),()=>{x.current&&(clearInterval(x.current),x.current=null),f.current&&(f.current.abort(),f.current=null)}},[p,I,h,i]);const B=c.useCallback(()=>{I()},[I]);return{...u,refetch:B}}const yt=new Set(["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY","NIFTYNXT50","NIFTYIT","NIFTYPHARMA","NIFTYBANK"]),Nt=new Set(["SENSEX","BANKEX","SENSEX50"]);function Ee(s,t){return yt.has(s)?"NSE_INDEX":Nt.has(s)?"BSE_INDEX":t==="BFO"?"BSE":"NSE"}function ce(s,t){if(s!=null)return!t||t<=0?s:Number((Math.round(s/t)*t).toFixed(2))}function vt(s,t,l,a,o,d,i={enabled:!0,oiRefreshInterval:3e4,pauseWhenHidden:!0}){const{enabled:h,oiRefreshInterval:j=3e4,pauseWhenHidden:C=!0}=i,[u,r]=c.useState(null),[x,f]=c.useState(null),{data:p,isLoading:I,isConnected:B,isPaused:T,error:b,lastUpdate:m,refetch:g}=jt(s,t,l,o,d,{enabled:h,refreshInterval:j,pauseWhenHidden:C}),S=c.useMemo(()=>{const w=[],A=Ee(t,a);if(w.push({symbol:t,exchange:A}),p?.chain)for(const Y of p.chain)Y.ce?.symbol&&w.push({symbol:Y.ce.symbol,exchange:a}),Y.pe?.symbol&&w.push({symbol:Y.pe.symbol,exchange:a});return w},[p?.chain,a,t]),{data:L,isConnected:E,isAuthenticated:y,isPaused:q}=ze({symbols:S,mode:"Depth",enabled:h&&S.length>0}),X=c.useRef(0);c.useEffect(()=>{if(!p){r(null);return}if(L.size===0){r(p);return}const w=p.chain.map(_=>{const O={..._};if(_.ce?.symbol){const k=`${a}:${_.ce.symbol}`,R=L.get(k);if(R?.data){const K=R.data.depth?.buy?.[0],Q=R.data.depth?.sell?.[0],V=_.ce.tick_size;O.ce={..._.ce,ltp:ce(R.data.ltp,V)??_.ce.ltp,bid:ce(K?.price??R.data.bid_price,V)??_.ce.bid,ask:ce(Q?.price??R.data.ask_price,V)??_.ce.ask,bid_qty:K?.quantity??R.data.bid_size??_.ce.bid_qty??0,ask_qty:Q?.quantity??R.data.ask_size??_.ce.ask_qty??0}}}if(_.pe?.symbol){const k=`${a}:${_.pe.symbol}`,R=L.get(k);if(R?.data){const K=R.data.depth?.buy?.[0],Q=R.data.depth?.sell?.[0],V=_.pe.tick_size;O.pe={..._.pe,ltp:ce(R.data.ltp,V)??_.pe.ltp,bid:ce(K?.price??R.data.bid_price,V)??_.pe.bid,ask:ce(Q?.price??R.data.ask_price,V)??_.pe.ask,bid_qty:K?.quantity??R.data.bid_size??_.pe.bid_qty??0,ask_qty:Q?.quantity??R.data.ask_size??_.pe.ask_qty??0}}}return O});let A=!1;for(const[,_]of L)if(_.lastUpdate&&_.lastUpdate>X.current){A=!0,X.current=_.lastUpdate;break}A&&f(new Date);const N=`${Ee(t,a)}:${t}`,U=L.get(N)?.data?.ltp??p.underlying_ltp;r({...p,underlying_ltp:U,chain:w})},[p,L,a,t]);const W=E&&y&&S.length>0,Z=T||q,v=c.useMemo(()=>!m&&!x?null:m?x&&x>m?x:m:x,[m,x]);return{data:u,isLoading:I,isConnected:B,isStreaming:W,isPaused:Z,error:b,lastUpdate:v,streamingSymbols:S.length,refetch:g}}const $=[{key:"ce_oi",label:"OI",side:"ce",width:"w-20",align:"right",defaultVisible:!0,formatter:"number"},{key:"ce_volume",label:"Volume",side:"ce",width:"w-20",align:"right",defaultVisible:!0,formatter:"number"},{key:"ce_bid_qty",label:"Bid Qty",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"number"},{key:"ce_bid",label:"Bid",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"price"},{key:"ce_ltp",label:"LTP",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"price"},{key:"ce_ask",label:"Ask",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"price"},{key:"ce_ask_qty",label:"Ask Qty",side:"ce",width:"w-16",align:"right",defaultVisible:!0,formatter:"number"},{key:"ce_spread",label:"Spread",side:"ce",width:"w-14",align:"right",defaultVisible:!0,formatter:"spread"},{key:"strike",label:"Strike",side:"center",width:"w-20",align:"center",defaultVisible:!0,formatter:"none"},{key:"pe_spread",label:"Spread",side:"pe",width:"w-14",align:"left",defaultVisible:!0,formatter:"spread"},{key:"pe_ask_qty",label:"Ask Qty",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"number"},{key:"pe_ask",label:"Ask",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"price"},{key:"pe_ltp",label:"LTP",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"price"},{key:"pe_bid",label:"Bid",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"price"},{key:"pe_bid_qty",label:"Bid Qty",side:"pe",width:"w-16",align:"left",defaultVisible:!0,formatter:"number"},{key:"pe_volume",label:"Volume",side:"pe",width:"w-20",align:"left",defaultVisible:!0,formatter:"number"},{key:"pe_oi",label:"OI",side:"pe",width:"w-20",align:"left",defaultVisible:!0,formatter:"number"}],Ct=$.map(s=>s.key),St=$.filter(s=>s.defaultVisible).map(s=>s.key),G={visibleColumns:St,columnOrder:Ct,strikeCount:10,selectedUnderlying:"NIFTY",barDataSource:"oi",barStyle:"gradient"},He="openalgo_option_chain_prefs";function wt(){if(typeof window>"u")return G;try{const s=localStorage.getItem(He);if(!s)return G;const t=JSON.parse(s),l=new Set($.map(i=>i.key)),a=Array.isArray(t.visibleColumns)?t.visibleColumns.filter(i=>l.has(i)):G.visibleColumns;a.includes("strike")||a.push("strike");const o=Array.isArray(t.columnOrder)?t.columnOrder.filter(i=>l.has(i)):G.columnOrder,d=new Set(o);return G.columnOrder.forEach(i=>{d.has(i)||o.push(i)}),{visibleColumns:a,columnOrder:o,strikeCount:typeof t.strikeCount=="number"&&t.strikeCount>0?t.strikeCount:G.strikeCount,selectedUnderlying:typeof t.selectedUnderlying=="string"&&t.selectedUnderlying?t.selectedUnderlying:G.selectedUnderlying,barDataSource:t.barDataSource==="oi"||t.barDataSource==="volume"?t.barDataSource:G.barDataSource,barStyle:t.barStyle==="gradient"||t.barStyle==="solid"?t.barStyle:G.barStyle}}catch{return G}}function kt(s){if(!(typeof window>"u"))try{localStorage.setItem(He,JSON.stringify(s))}catch{}}function Dt(){const[s,t]=c.useState(()=>wt());c.useEffect(()=>{kt(s)},[s]);const l=c.useCallback(r=>{r!=="strike"&&t(x=>{const p=x.visibleColumns.includes(r)?x.visibleColumns.filter(I=>I!==r):[...x.visibleColumns,r];return{...x,visibleColumns:p}})},[]),a=c.useCallback(r=>{t(x=>({...x,columnOrder:r}))},[]),o=c.useCallback(r=>{t(x=>({...x,strikeCount:r}))},[]),d=c.useCallback(r=>{t(x=>({...x,selectedUnderlying:r}))},[]),i=c.useCallback(r=>{t(x=>({...x,barDataSource:r}))},[]),h=c.useCallback(r=>{t(x=>({...x,barStyle:r}))},[]),j=c.useCallback(()=>{t(G)},[]),C=c.useCallback(r=>s.visibleColumns.includes(r),[s.visibleColumns]),u=c.useCallback(()=>s.columnOrder.filter(r=>s.visibleColumns.includes(r)),[s.columnOrder,s.visibleColumns]);return{preferences:s,visibleColumns:s.visibleColumns,columnOrder:s.columnOrder,strikeCount:s.strikeCount,selectedUnderlying:s.selectedUnderlying,barDataSource:s.barDataSource,barStyle:s.barStyle,toggleColumn:l,reorderColumns:a,setStrikeCount:o,setSelectedUnderlying:d,setBarDataSource:i,setBarStyle:h,resetToDefaults:j,isColumnVisible:C,getOrderedVisibleColumns:u}}function Pt({barDataSource:s,barStyle:t,onBarDataSourceChange:l,onBarStyleChange:a}){return e.jsxs(Ue,{children:[e.jsx(Ve,{asChild:!0,children:e.jsxs(z,{variant:"outline",size:"icon",className:"h-9 w-9",children:[e.jsx(st,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Bar settings"})]})}),e.jsxs(qe,{align:"end",className:"w-48",children:[e.jsx(ye,{children:"Bar Data"}),e.jsxs(Pe,{value:s,onValueChange:o=>l(o),children:[e.jsx(fe,{value:"oi",children:"Open Interest"}),e.jsx(fe,{value:"volume",children:"Volume"})]}),e.jsx(Ce,{}),e.jsx(ye,{children:"Bar Style"}),e.jsxs(Pe,{value:t,onValueChange:o=>a(o),children:[e.jsx(fe,{value:"gradient",children:"Gradient"}),e.jsx(fe,{value:"solid",children:"Solid"})]})]})]})}function _t({visibleColumns:s,onToggleColumn:t,onResetToDefaults:l}){const a=$.filter(i=>i.side==="ce"),o=$.filter(i=>i.side==="pe"),d=i=>s.includes(i);return e.jsxs(Ue,{children:[e.jsx(Ve,{asChild:!0,children:e.jsxs(z,{variant:"outline",size:"icon",className:"h-9 w-9",children:[e.jsx(at,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Column settings"})]})}),e.jsxs(qe,{align:"end",className:"w-48",children:[e.jsx(ye,{children:"CALLS Columns"}),a.map(i=>e.jsx(_e,{checked:d(i.key),onCheckedChange:()=>t(i.key),children:i.label},i.key)),e.jsx(Ce,{}),e.jsx(ye,{children:"PUTS Columns"}),o.map(i=>e.jsx(_e,{checked:d(i.key),onCheckedChange:()=>t(i.key),children:i.label},i.key)),e.jsx(Ce,{}),e.jsxs(z,{variant:"ghost",size:"sm",className:"w-full justify-start px-2",onClick:l,children:[e.jsx(rt,{className:"mr-2 h-4 w-4"}),"Reset to Defaults"]})]})]})}function Oe({columnKey:s,label:t,side:l,isVisible:a,isDragging:o,onDragStart:d,onDragOver:i,onDrop:h,onDragEnd:j}){return e.jsxs("div",{draggable:!0,onDragStart:C=>d(C,s),onDragOver:i,onDrop:C=>h(C,s),onDragEnd:j,className:P("flex items-center gap-2 rounded-md border px-3 py-2 cursor-grab active:cursor-grabbing transition-all",o&&"opacity-50 border-dashed",a?"bg-card":"bg-muted/50 opacity-60",l==="ce"?"border-l-2 border-l-green-500":"border-r-2 border-r-red-500"),children:[e.jsx(lt,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"text-sm flex-1",children:t}),e.jsx("span",{className:P("text-xs px-1.5 py-0.5 rounded",l==="ce"?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"),children:l==="ce"?"CE":"PE"})]})}function Tt({columnOrder:s,visibleColumns:t,onReorderColumns:l}){const[a,o]=c.useState(s),[d,i]=c.useState(null),[h,j]=c.useState(!1),C=a.filter(m=>$.find(S=>S.key===m)?.side==="ce"),u=a.filter(m=>$.find(S=>S.key===m)?.side==="pe"),r=m=>$.find(S=>S.key===m)?.label??m,x=m=>$.find(S=>S.key===m)?.side==="pe"?"pe":"ce",f=(m,g)=>{i(g),m.dataTransfer.effectAllowed="move",m.dataTransfer.setData("text/plain",g)},p=m=>{m.preventDefault(),m.dataTransfer.dropEffect="move"},I=(m,g)=>{if(m.preventDefault(),!d||d===g)return;const S=x(d),L=x(g);if(S!==L)return;const E=[...a],y=E.indexOf(d),q=E.indexOf(g);E.splice(y,1),E.splice(q,0,d),o(E)},B=()=>{i(null)},T=()=>{l(a),j(!1)},b=m=>{j(m),m&&o(s)};return e.jsxs(Ye,{open:h,onOpenChange:b,children:[e.jsx(dt,{asChild:!0,children:e.jsxs(z,{variant:"outline",size:"icon",className:"h-9 w-9",children:[e.jsx(nt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Reorder columns"})]})}),e.jsxs($e,{className:"sm:max-w-md",children:[e.jsxs(Qe,{children:[e.jsx(We,{children:"Reorder Columns"}),e.jsx(ut,{children:"Drag columns to reorder them. CE and PE columns can only be reordered within their respective sections."})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2 text-green-500",children:"CALLS (CE)"}),e.jsx(Le,{className:"h-64 pr-2",children:e.jsx("div",{className:"space-y-1.5",children:C.map(m=>e.jsx(Oe,{columnKey:m,label:r(m),side:"ce",isVisible:t.includes(m),isDragging:d===m,onDragStart:f,onDragOver:p,onDrop:I,onDragEnd:B},m))})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-2 text-red-500",children:"PUTS (PE)"}),e.jsx(Le,{className:"h-64 pr-2",children:e.jsx("div",{className:"space-y-1.5",children:u.map(m=>e.jsx(Oe,{columnKey:m,label:r(m),side:"pe",isVisible:t.includes(m),isDragging:d===m,onDragStart:f,onDragOver:p,onDrop:I,onDragEnd:B},m))})})]})]}),e.jsxs(Xe,{className:"gap-2 sm:gap-0",children:[e.jsx(mt,{asChild:!0,children:e.jsx(z,{variant:"outline",children:"Cancel"})}),e.jsx(z,{onClick:T,children:"Save Order"})]})]})]})}function Mt(s){switch(s){case"NFO":return"bg-purple-500/20 text-purple-400 border-purple-500/30";case"BFO":return"bg-amber-500/20 text-amber-400 border-amber-500/30";case"NSE":return"bg-blue-500/20 text-blue-400 border-blue-500/30";case"BSE":return"bg-pink-500/20 text-pink-400 border-pink-500/30";case"MCX":return"bg-orange-500/20 text-orange-400 border-orange-500/30";case"CDS":return"bg-cyan-500/20 text-cyan-400 border-cyan-500/30";case"BCD":return"bg-rose-500/20 text-rose-400 border-rose-500/30";default:return"bg-gray-500/20 text-gray-400 border-gray-500/30"}}function Lt({exchange:s,ltp:t,prevClose:l,change:a,changePercent:o,bidPrice:d,askPrice:i,bidSize:h,askSize:j,isLoading:C}){const u=a??(t&&l?t-l:void 0),r=o??(u&&l?u/l*100:void 0),x=u!==void 0&&u>=0;return C?e.jsxs("div",{className:"p-3 bg-muted/30 rounded-lg animate-pulse",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-24 mb-2"}),e.jsx("div",{className:"h-6 bg-muted rounded w-32"})]}):e.jsxs("div",{className:"p-3 bg-muted/30 rounded-lg space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Ae,{className:P("text-[10px] px-1.5 py-0",Mt(s)),children:s}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl font-bold",children:t!==void 0?t.toFixed(2):"-"}),u!==void 0&&e.jsxs("span",{className:P("text-sm font-medium",x?"text-green-500":"text-red-500"),children:[x?"+":"",u.toFixed(2),r!==void 0&&e.jsxs("span",{className:"ml-1",children:["(",x?"+":"",r.toFixed(2),"%)"]})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm border-t border-border/50 pt-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Bid:"}),e.jsx("span",{className:"text-emerald-400 font-medium font-mono",children:d!==void 0&&d>0?d.toFixed(2):"-"}),h!==void 0&&h>0&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:["x",h.toLocaleString()]})]}),e.jsx("div",{className:"text-muted-foreground",children:"|"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Ask:"}),e.jsx("span",{className:"text-rose-400 font-medium font-mono",children:i!==void 0&&i>0?i.toFixed(2):"-"}),j!==void 0&&j>0&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:["x",j.toLocaleString()]})]})]})]})}function Ie({price:s,quantity:t,maxQty:l,side:a}){const o=l>0?Math.min(t/l*100,100):0;return e.jsxs("div",{className:"relative flex items-center gap-2 py-1 px-2",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden",children:e.jsx("div",{className:P("absolute top-0 bottom-0 transition-all duration-300",a==="buy"?"left-0 bg-gradient-to-r from-emerald-500/20 to-transparent":"right-0 bg-gradient-to-l from-rose-500/20 to-transparent"),style:{width:`${o}%`}})}),e.jsx("span",{className:P("relative z-10 flex-1 font-mono text-xs",a==="buy"?"text-emerald-400":"text-rose-400"),children:s.toFixed(2)}),e.jsx("span",{className:"relative z-10 font-mono text-xs text-muted-foreground",children:t.toLocaleString()})]})}function Et({depth:s,isExpanded:t,onToggle:l,maxLevels:a=5}){const o=s?.buy?.slice(0,a)??[],d=s?.sell?.slice(0,a)??[],i=Math.max(...o.map(u=>u.quantity),1),h=Math.max(...d.map(u=>u.quantity),1),j=Math.max(i,h),C=o.length>0||d.length>0;return e.jsxs(xt,{open:t,onOpenChange:l,children:[e.jsxs(ht,{className:"flex items-center justify-between w-full py-2 px-3 bg-muted/20 rounded hover:bg-muted/30 transition-colors",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:[t?"Hide":"Show"," Market Depth"]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t?"[-]":"[+]"})]}),e.jsx(pt,{children:C?e.jsxs("div",{className:"mt-2 border rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"grid grid-cols-2 bg-muted/30",children:[e.jsx("div",{className:"px-2 py-1.5 text-xs font-medium text-emerald-500 border-r",children:"Bids"}),e.jsx("div",{className:"px-2 py-1.5 text-xs font-medium text-rose-500",children:"Asks"})]}),e.jsxs("div",{className:"grid grid-cols-2 divide-x",children:[e.jsx("div",{className:"divide-y divide-border/50",children:o.length>0?o.map((u,r)=>e.jsx(Ie,{price:u.price,quantity:u.quantity,maxQty:j,side:"buy"},`buy-${r}`)):e.jsx("div",{className:"py-2 text-center text-xs text-muted-foreground",children:"-"})}),e.jsx("div",{className:"divide-y divide-border/50",children:d.length>0?d.map((u,r)=>e.jsx(Ie,{price:u.price,quantity:u.quantity,maxQty:j,side:"sell"},`sell-${r}`)):e.jsx("div",{className:"py-2 text-center text-xs text-muted-foreground",children:"-"})})]}),e.jsxs("div",{className:"grid grid-cols-2 bg-muted/30 border-t divide-x",children:[e.jsxs("div",{className:"px-2 py-1.5 text-xs text-muted-foreground flex justify-between",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{className:"font-mono text-emerald-400",children:o.reduce((u,r)=>u+r.quantity,0).toLocaleString()})]}),e.jsxs("div",{className:"px-2 py-1.5 text-xs text-muted-foreground flex justify-between",children:[e.jsx("span",{className:"font-mono text-rose-400",children:d.reduce((u,r)=>u+r.quantity,0).toLocaleString()}),e.jsx("span",{children:"Total"})]})]})]}):e.jsx("div",{className:"py-4 text-center text-sm text-muted-foreground",children:"No depth data available"})})]})}function Ot(s,t,l={}){const{enabled:a=!0,mode:o="Depth",useQuotesFallback:d=!0,useDepthFallback:i=!0,staleThreshold:h=5e3,refreshInterval:j=3e4}=l,{apiKey:C}=ke(),{isMarketOpen:u}=tt(),[r,x]=c.useState(null),[f,p]=c.useState(null),[I,B]=c.useState(!1),T=c.useRef(0),b=!!s&&!!t,m=c.useMemo(()=>b?[{symbol:s,exchange:t}]:[],[s,t,b]),{data:g,isConnected:S,isPaused:L,isFallbackMode:E}=ze({symbols:m,mode:o,enabled:a&&b}),y=g.get(`${t}:${s}`)?.data,q=g.get(`${t}:${s}`)?.lastUpdate,X=u(t),W=!!(S&&y&&q&&Date.now()-q<h),Z=W&&X&&!L,v=c.useCallback(async()=>{if(!(!C||!b)){B(!0);try{const O=[];d&&O.push(Se.getQuotes(C,s,t).then(k=>{k.status==="success"&&k.data&&x(k.data)}).catch(()=>{console.debug("REST quotes fetch failed")})),i&&o==="Depth"&&O.push(Se.getDepth(C,s,t).then(k=>{k.status==="success"&&k.data&&p(k.data)}).catch(()=>{console.debug("REST depth fetch failed")})),await Promise.all(O),T.current=Date.now()}finally{B(!1)}}},[C,s,t,b,d,i,o]),w=c.useRef(a),A=c.useRef(b),Y=c.useRef(v);c.useEffect(()=>{w.current=a,A.current=b,Y.current=v},[a,b,v]),c.useEffect(()=>{if(!a||!b)return;Y.current();const O=setInterval(()=>{w.current&&A.current&&Y.current()},j);return()=>clearInterval(O)},[a,b,s,t,j]),c.useEffect(()=>{x(null),p(null)},[s,t]);const N=c.useMemo(()=>{if(f)return{buy:f.bids.map(O=>({price:O.price,quantity:O.quantity})),sell:f.asks.map(O=>({price:O.price,quantity:O.quantity}))}},[f]),F=c.useMemo(()=>{const O=y?.depth??N,k=y?.depth?.buy?.[0]?.price??N?.buy?.[0]?.price??y?.bid_price??r?.bid,R=y?.depth?.sell?.[0]?.price??N?.sell?.[0]?.price??y?.ask_price??r?.ask,K=y?.depth?.buy?.[0]?.quantity??N?.buy?.[0]?.quantity??y?.bid_size,Q=y?.depth?.sell?.[0]?.quantity??N?.sell?.[0]?.quantity??y?.ask_size;return{ltp:y?.ltp??f?.ltp??r?.ltp,open:y?.open??f?.open??r?.open,high:y?.high??f?.high??r?.high,low:y?.low??f?.low??r?.low,close:y?.close??f?.prev_close??r?.prev_close,volume:y?.volume??f?.volume??r?.volume,oi:f?.oi??r?.oi,change:y?.change,changePercent:y?.change_percent,bidPrice:k,askPrice:R,bidSize:K,askSize:Q,depth:O}},[y,r,f,N]),U=c.useMemo(()=>{if(F.change!==void 0)return F;const O=F.ltp&&F.close?F.ltp-F.close:void 0,k=O&&F.close?O/F.close*100:void 0;return{...F,change:O,changePercent:k}},[F]),_=c.useMemo(()=>W?"websocket":r||f?"rest":"none",[W,r,f]);return{data:U,isLive:Z,isConnected:S,isLoading:I&&!r&&!f,isPaused:L,isFallbackMode:E,dataSource:_,refresh:v}}const It=[{value:"MARKET",label:"Market"},{value:"LIMIT",label:"Limit"},{value:"SL-M",label:"SL-M"},{value:"SL",label:"SL-L"}],Ft=[{value:"NRML",label:"NRML"},{value:"MIS",label:"MIS"}],Rt=[{value:"CNC",label:"CNC"},{value:"MIS",label:"MIS"}];function je(s,t){return t<=0?s:Number((Math.round(s/t)*t).toFixed(2))}function ge(s,t,l){const a=je(s,t);return l==="up"?Number((a+t).toFixed(2)):Math.max(0,Number((a-t).toFixed(2)))}function Fe(s){return["NFO","BFO","MCX","CDS","BCD","NCDEX"].includes(s)}function Bt({open:s,onOpenChange:t,symbol:l="",exchange:a="",action:o="BUY",quantity:d,lotSize:i=1,tickSize:h=.05,product:j="NRML",priceType:C="MARKET",strategy:u="OptionChain",onSuccess:r,onError:x}){const{apiKey:f}=ke(),[p,I]=c.useState(o),[B,T]=c.useState(d??i),[b,m]=c.useState(C),[g,S]=c.useState(j),[L,E]=c.useState(0),[y,q]=c.useState(0),[X,W]=c.useState(!1),[Z,v]=c.useState(!1),[w,A]=c.useState("lots"),[Y,N]=c.useState(1),F=Fe(a)?Ft:Rt,{data:U,isLoading:_,isConnected:O}=Ot(l,a,{enabled:s&&!!l&&!!a,mode:"Depth",useQuotesFallback:!0,useDepthFallback:!0});c.useEffect(()=>{if(s){I(o),T(d??i),m(C);const n=Fe(a),D=n?"NRML":"CNC",te=j&&(n?["NRML","MIS"]:["CNC","MIS"]).includes(j)?j:D;S(te),E(0),q(0),v(!1),A("lots"),N(1)}},[s,o,d,i,C,j,a]);const k={ltp:U.ltp,close:U.close,change:U.change,change_percent:U.changePercent,bidPrice:U.bidPrice,askPrice:U.askPrice,bidSize:U.bidSize,askSize:U.askSize,depth:U.depth},R=k.change,K=k.change_percent;c.useEffect(()=>{b!=="MARKET"&&k.ltp&&L===0&&E(je(k.ltp,h))},[b,k.ltp,L,h]);const Q=b==="LIMIT"||b==="SL",V=b==="SL-M"||b==="SL",ee=c.useCallback(()=>!(!l||!a||!f||B<=0||Q&&L<=0||V&&y<=0),[l,a,f,B,Q,L,V,y]),Ne=async()=>{if(!ee()){pe.error("Please fill all required fields");return}if(!f){pe.error("API key not found. Please set up your API key."),x?.("API key not found");return}W(!0);try{const D={apikey:f,strategy:u,exchange:a,symbol:l,action:p,quantity:B,pricetype:b,product:g,...Q&&{price:L},...V&&{trigger_price:y}},M=await Se.placeOrder(D),te=M.orderid;if(M.status==="success"&&te)r?.(te),t(!1);else{const De=M.message||"Order placement failed";pe.error(De,"orders"),x?.(De)}}catch(n){let D="Order placement failed";if(n&&typeof n=="object"){const M=n;M.response?.data?.message?D=M.response.data.message:M.message&&(D=M.message)}pe.error(D,"orders"),x?.(D)}finally{W(!1)}},H=n=>{const D=parseInt(n)||0;if(w==="lots")T(D*i),N(D);else{const M=Math.max(i,Math.round(D/i)*i);T(M),N(M/i)}},re=w==="lots"?Y:B,ne=_&&!k.ltp&&!O;return e.jsx(Ye,{open:s,onOpenChange:t,children:e.jsxs($e,{className:"sm:max-w-[420px]","aria-describedby":void 0,children:[e.jsx(Qe,{children:e.jsxs(We,{className:"flex items-center gap-2",children:[e.jsx("span",{children:"Place Order -"}),e.jsx("span",{className:p==="BUY"?"text-green-500":"text-red-500",children:p}),e.jsx("span",{className:"text-muted-foreground font-normal text-sm truncate",children:l})]})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx(Lt,{exchange:a,ltp:k.ltp,prevClose:k.close,change:R,changePercent:K,bidPrice:k.bidPrice,askPrice:k.askPrice,bidSize:k.bidSize,askSize:k.askSize,isLoading:ne}),e.jsx(Et,{depth:k.depth,isExpanded:Z,onToggle:()=>v(!Z),maxLevels:5}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{className:"text-xs",children:"Action"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(z,{type:"button",variant:p==="BUY"?"default":"outline",className:P("flex-1",p==="BUY"&&"bg-green-600 hover:bg-green-700"),onClick:()=>I("BUY"),children:"BUY"}),e.jsx(z,{type:"button",variant:p==="SELL"?"default":"outline",className:P("flex-1",p==="SELL"&&"bg-red-600 hover:bg-red-700"),onClick:()=>I("SELL"),children:"SELL"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(le,{className:"text-xs",children:"Quantity"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{type:"button",onClick:()=>A("lots"),className:P("px-2 py-0.5 text-[10px] rounded",w==="lots"?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-muted/80"),children:"Lots"}),e.jsx("button",{type:"button",onClick:()=>A("shares"),className:P("px-2 py-0.5 text-[10px] rounded",w==="shares"?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-muted/80"),children:"Shares"})]})]}),e.jsx(be,{type:"number",value:re,onChange:n=>H(n.target.value),min:1}),e.jsxs("div",{className:"flex justify-between text-[10px] text-muted-foreground",children:[e.jsxs("span",{children:["Lot size: ",i]}),e.jsxs("span",{children:["Total qty: ",B]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{className:"text-xs",children:"Price Type"}),e.jsxs(oe,{value:b,onValueChange:n=>m(n),children:[e.jsx(de,{children:e.jsx(ue,{})}),e.jsx(me,{children:It.map(n=>e.jsx(xe,{value:n.value,children:n.label},n.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{className:"text-xs",children:"Product"}),e.jsxs(oe,{value:g,onValueChange:n=>S(n),children:[e.jsx(de,{children:e.jsx(ue,{})}),e.jsx(me,{children:F.map(n=>e.jsx(xe,{value:n.value,children:n.label},n.value))})]})]})]}),Q&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{className:"text-xs",children:"Price"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(z,{type:"button",variant:"outline",size:"sm",className:"px-2",onClick:()=>E(ge(L,h,"down")),children:"-"}),e.jsx(be,{type:"number",value:L,onChange:n=>E(parseFloat(n.target.value)||0),onBlur:()=>E(je(L,h)),className:"flex-1 text-center",step:h,min:0}),e.jsx(z,{type:"button",variant:"outline",size:"sm",className:"px-2",onClick:()=>E(ge(L,h,"up")),children:"+"})]}),e.jsxs("p",{className:"text-[10px] text-muted-foreground",children:["Tick size: ",h]})]}),V&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(le,{className:"text-xs",children:"Trigger Price"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(z,{type:"button",variant:"outline",size:"sm",className:"px-2",onClick:()=>q(ge(y,h,"down")),children:"-"}),e.jsx(be,{type:"number",value:y,onChange:n=>q(parseFloat(n.target.value)||0),onBlur:()=>q(je(y,h)),className:"flex-1 text-center",step:h,min:0}),e.jsx(z,{type:"button",variant:"outline",size:"sm",className:"px-2",onClick:()=>q(ge(y,h,"up")),children:"+"})]})]})]}),e.jsxs(Xe,{className:"gap-2 sm:gap-0",children:[e.jsx(z,{variant:"outline",onClick:()=>t(!1),disabled:X,children:"Cancel"}),e.jsx(z,{onClick:Ne,disabled:!ee()||X,className:P(p==="BUY"?"bg-green-600 hover:bg-green-700":"bg-red-600 hover:bg-red-700"),children:X?"Placing...":`Place ${p} Order`})]})]})})}const Ut=[{value:"NFO",label:"NFO"},{value:"BFO",label:"BFO"}],Re={NFO:["NIFTY","BANKNIFTY","FINNIFTY","MIDCPNIFTY"],BFO:["SENSEX","BANKEX"]},Vt=[{value:5,label:"5 strikes"},{value:10,label:"10 strikes"},{value:15,label:"15 strikes"},{value:20,label:"20 strikes"},{value:25,label:"25 strikes"}];function he(s){if(s==null||s===0)return"0";const t=s/1e5;if(t>=100)return t.toFixed(0)+"L";if(t>=10)return t.toFixed(1)+"L";if(t>=1)return t.toFixed(2)+"L";{const l=s/1e3;return l>=1?l.toFixed(1)+"K":s.toLocaleString()}}function J(s){return s==null?"0.00":s.toFixed(2)}function qt(s){if(!s)return"";const t=s.split("-");return t.length===3?`${t[0]}${t[1].toUpperCase()}${t[2].slice(-2)}`:s.replace(/-/g,"").toUpperCase()}function Ke(s){let t=0,l=0;return s.forEach(a=>{a.ce?.oi&&(t+=a.ce.oi),a.pe?.oi&&(l+=a.pe?.oi??0)}),t===0?0:l/t}function Ge(s){let t=0,l=0,a=0,o=0;return s.forEach(d=>{d.ce&&(t+=d.ce.volume??0,a+=d.ce.oi??0),d.pe&&(l+=d.pe.volume??0,o+=d.pe.oi??0)}),{ceVolume:t,peVolume:l,ceOi:a,peOi:o}}function At(s,t){let l=0;return s.forEach(a=>{const o=t==="oi"?a.ce?.oi:a.ce?.volume,d=t==="oi"?a.pe?.oi:a.pe?.volume;o&&o>l&&(l=o),d&&d>l&&(l=d)}),l||1}function zt(s){const t=s.chain,l=Ke(t);let a=0;l>1.5?a=-3:l>1.2?a=-2:l>.9?a=-1:l<.5?a=3:l<.7?a=2:l<.9&&(a=1);const o=t.findIndex(g=>Math.abs(g.strike-s.atm_strike)<.01);let d=0;const i=t.slice(Math.max(0,o-2),Math.min(t.length,o+3)),h=i.reduce((g,S)=>g+(S.ce?.oi||0),0),j=i.reduce((g,S)=>g+(S.pe?.oi||0),0);h>j*1.3?d=-2:j>h*1.3&&(d=2);const C=t.find(g=>Math.abs(g.strike-s.atm_strike)<.01)?.ce,u=t.find(g=>Math.abs(g.strike-s.atm_strike)<.01)?.pe;let r=0;if(C&&u){const g=C.ltp/u.ltp;g>1.2?r=1:g<.8&&(r=-1)}const x=Ge(t),f=x.ceVolume/x.peVolume;let p=0;f>1.5?p=1:f<.67&&(p=-1);const I=s.underlying_ltp>s.underlying_prev_close?1:-1,B=Be(t,"ce",s.atm_strike),T=Be(t,"pe",s.atm_strike),b=a+d+r+p+I,m=Math.max(-10,Math.min(10,b));return{score:m,callPremiumTrend:B,putPremiumTrend:T,maxPain:Je(t),strength:Math.abs(m)>7?"Strong":Math.abs(m)>3?"Moderate":"Weak"}}function Be(s,t,l){const a=s.reduce((h,j)=>Math.abs(j.strike-l)<Math.abs(h.strike-l)?j:h),o=t==="ce"?a.ce?.ltp:a.pe?.ltp,d=s.find(h=>t==="ce"?h.strike>a.strike+50:h.strike<a.strike-50),i=d?t==="ce"?d.ce?.ltp:d.pe?.ltp:0;return!o||!i||i===0?0:(o-i)/i*100}function Je(s){const t=s.map(o=>o.strike);let l=1/0,a=t[0];return t.forEach(o=>{let d=0;s.forEach(i=>{i.ce&&i.strike<o&&(d+=(o-i.strike)*(i.ce.oi||0)),i.pe&&i.strike>o&&(d+=(i.strike-o)*(i.pe.oi||0))}),d<l&&(l=d,a=o)}),a}function Yt(s){return s>=8?"Strong Buy":s>=4?"Buy":s>=1?"Mild Buy":s<=-8?"Strong Sell":s<=-4?"Sell":s<=-1?"Mild Sell":"Neutral"}function $t(s){return s>=4?"text-green-600":s>=1?"text-green-400":s<=-4?"text-red-600":s<=-1?"text-red-400":"text-yellow-500"}const Qt=Ze.memo(function({strike:t,previousStrike:l,maxBarValue:a,visibleCeColumns:o,visiblePeColumns:d,barDataSource:i,barStyle:h,optionExchange:j,onPlaceOrder:C}){const u=t.ce,r=t.pe,x=u?.label??r?.label??"",f=x==="ATM",p=x.startsWith("OTM"),I=x.startsWith("ITM"),B=l?.ce?.ltp!==void 0&&l.ce.ltp!==u?.ltp,T=l?.pe?.ltp!==void 0&&l.pe.ltp!==r?.ltp,b=B?u&&l?.ce&&u.ltp>l.ce.ltp?"bg-green-500/30":"bg-red-500/30":"",m=T?r&&l?.pe&&r.ltp>l.pe.ltp?"bg-green-500/30":"bg-red-500/30":"",g=u&&u.bid>0&&u.ask>0?u.ask-u.bid:0,S=r&&r.bid>0&&r.ask>0?r.ask-r.bid:0,L=g<=1?"text-green-500":g<=2?"text-yellow-500":"text-red-500",E=S<=1?"text-green-500":S<=2?"text-yellow-500":"text-red-500",y=i==="oi"?u?.oi:u?.volume,q=i==="oi"?r?.oi:r?.volume,X=y?Math.min(y/a*100,100):0,W=q?Math.min(q/a*100,100):0,Z=h==="gradient"?"bg-gradient-to-r from-green-500/25 to-transparent":"bg-green-500/20",v=h==="gradient"?"bg-gradient-to-l from-red-500/25 to-transparent":"bg-red-500/20",w="font-mono tabular-nums text-xs",A=N=>{switch(N){case"ce_oi":return e.jsx("span",{className:w,children:he(u?.oi)});case"ce_volume":return e.jsx("span",{className:w,children:he(u?.volume)});case"ce_bid_qty":return e.jsx("span",{className:w,children:u?.bid_qty??0});case"ce_bid":return e.jsx("span",{className:P(w,"text-red-500"),children:J(u?.bid)});case"ce_ltp":return e.jsx("span",{className:P(w,"font-semibold",b),children:J(u?.ltp)});case"ce_ask":return e.jsx("span",{className:P(w,"text-green-500"),children:J(u?.ask)});case"ce_ask_qty":return e.jsx("span",{className:w,children:u?.ask_qty??0});case"ce_spread":return e.jsx("span",{className:P(w,L),children:J(g)});default:return null}},Y=N=>{switch(N){case"pe_oi":return e.jsx("span",{className:w,children:he(r?.oi)});case"pe_volume":return e.jsx("span",{className:w,children:he(r?.volume)});case"pe_bid_qty":return e.jsx("span",{className:w,children:r?.bid_qty??0});case"pe_bid":return e.jsx("span",{className:P(w,"text-red-500"),children:J(r?.bid)});case"pe_ltp":return e.jsx("span",{className:P(w,"font-semibold",m),children:J(r?.ltp)});case"pe_ask":return e.jsx("span",{className:P(w,"text-green-500"),children:J(r?.ask)});case"pe_ask_qty":return e.jsx("span",{className:w,children:r?.ask_qty??0});case"pe_spread":return e.jsx("span",{className:P(w,E),children:J(S)});default:return null}};return e.jsxs(we,{className:P("hover:bg-muted/50 relative group"),"data-strike":t.strike,"data-label":x,children:[o.length>0&&e.jsxs(ve,{className:P("p-0 relative",p&&!f&&"bg-amber-500/5"),children:[e.jsx("div",{className:P("absolute left-0 top-0 bottom-0 pointer-events-none z-0 transition-all duration-300",Z),style:{width:`${X}%`}}),u&&e.jsxs("div",{className:P("absolute right-1 top-1/2 -translate-y-1/2 z-20","flex gap-0.5","opacity-0 group-hover:opacity-100 transition-opacity"),children:[e.jsx("button",{onClick:N=>{N.stopPropagation(),C({symbol:u.symbol,exchange:j,action:"BUY",lotSize:u.lotsize??1,tickSize:u.tick_size??.05})},className:"px-1.5 py-0.5 text-[10px] font-bold rounded bg-green-600 text-white hover:bg-green-700",children:"B"}),e.jsx("button",{onClick:N=>{N.stopPropagation(),C({symbol:u.symbol,exchange:j,action:"SELL",lotSize:u.lotsize??1,tickSize:u.tick_size??.05})},className:"px-1.5 py-0.5 text-[10px] font-bold rounded bg-amber-600 text-white hover:bg-amber-700",children:"S"})]}),e.jsx("div",{className:"relative z-10 flex",children:o.map(N=>{const F=$.find(U=>U.key===N);return e.jsx("div",{className:P("flex-1 px-2 py-1.5 min-w-0",F?.align==="right"&&"text-right",F?.align==="center"&&"text-center",F?.align==="left"&&"text-left"),children:A(N)},N)})})]}),e.jsx(ve,{className:P("text-center font-bold px-2 py-1.5 text-sm w-20 min-w-20",f?"bg-primary/15":"bg-muted/30"),children:t.strike}),d.length>0&&e.jsxs(ve,{className:P("p-0 relative",I&&!f&&"bg-amber-500/5"),children:[e.jsx("div",{className:P("absolute right-0 top-0 bottom-0 pointer-events-none z-0 transition-all duration-300",v),style:{width:`${W}%`}}),r&&e.jsxs("div",{className:P("absolute left-1 top-1/2 -translate-y-1/2 z-20","flex gap-0.5","opacity-0 group-hover:opacity-100 transition-opacity"),children:[e.jsx("button",{onClick:N=>{N.stopPropagation(),C({symbol:r.symbol,exchange:j,action:"BUY",lotSize:r.lotsize??1,tickSize:r.tick_size??.05})},className:"px-1.5 py-0.5 text-[10px] font-bold rounded bg-green-600 text-white hover:bg-green-700",children:"B"}),e.jsx("button",{onClick:N=>{N.stopPropagation(),C({symbol:r.symbol,exchange:j,action:"SELL",lotSize:r.lotsize??1,tickSize:r.tick_size??.05})},className:"px-1.5 py-0.5 text-[10px] font-bold rounded bg-amber-600 text-white hover:bg-amber-700",children:"S"})]}),e.jsx("div",{className:"relative z-10 flex",children:d.map(N=>{const F=$.find(U=>U.key===N);return e.jsx("div",{className:P("flex-1 px-2 py-1.5 min-w-0",F?.align==="right"&&"text-right",F?.align==="center"&&"text-center",F?.align==="left"&&"text-left"),children:Y(N)},N)})})]})]})});function ds(){const{apiKey:s}=ke(),{visibleColumns:t,columnOrder:l,strikeCount:a,selectedUnderlying:o,barDataSource:d,barStyle:i,toggleColumn:h,reorderColumns:j,setStrikeCount:C,setSelectedUnderlying:u,setBarDataSource:r,setBarStyle:x,resetToDefaults:f}=Dt(),[p,I]=c.useState("NFO"),[B,T]=c.useState(Re.NFO),[b,m]=c.useState(""),[g,S]=c.useState([]),L=c.useRef(new Map),[E,y]=c.useState(null),[q,X]=c.useState(""),W=p,Z=p,{data:v,isConnected:w,isStreaming:A,isPaused:Y,error:N,lastUpdate:F,refetch:U,isLoading:_,streamingSymbols:O}=vt(s,o,Z,W,qt(b),a,{enabled:!!b,oiRefreshInterval:3e4,pauseWhenHidden:!0});c.useEffect(()=>{const n=Re[p]||[];T(n),u(n[0]||""),S([]),m("");let D=!1;return(async()=>{try{const te=await Te.getUnderlyings(p);if(D)return;te.status==="success"&&te.underlyings.length>0&&(T(te.underlyings),te.underlyings.includes(n[0])||u(te.underlyings[0]))}catch{}})(),()=>{D=!0}},[p]),c.useEffect(()=>{if(!o)return;S([]),m("");let n=!1;return(async()=>{try{const M=await Te.getExpiries(p,o);if(n)return;M.status==="success"&&M.expiries.length>0?(S(M.expiries),m(M.expiries[0])):(S([]),m(""))}catch{if(n)return;pe.error("Failed to load expiry dates")}})(),()=>{n=!0}},[o]),c.useEffect(()=>{if(v?.chain){const n=setTimeout(()=>{const D=new Map;v.chain.forEach(M=>{D.set(M.strike,M)}),L.current=D},100);return()=>clearTimeout(n)}},[v?.chain]);const k=n=>{u(n),m(""),S([])},R=()=>{U()},K=c.useCallback(n=>{y({open:!0,symbol:n.symbol,exchange:n.exchange,action:n.action,quantity:n.lotSize,lotSize:n.lotSize,tickSize:n.tickSize})},[]),Q=c.useCallback(n=>{n||y(null)},[]),V=c.useMemo(()=>v?.chain?Ke(v.chain):0,[v?.chain]),ee=c.useMemo(()=>v?.chain?Ge(v.chain):{ceVolume:0,peVolume:0,ceOi:0,peOi:0},[v?.chain]),Ne=c.useMemo(()=>v?.chain?At(v.chain,d):1,[v?.chain,d]),H=c.useMemo(()=>v?zt(v):{score:0,callPremiumTrend:0,putPremiumTrend:0,maxPain:0,strength:"Weak"},[v]),re=c.useMemo(()=>l.filter(n=>$.find(M=>M.key===n)?.side==="ce"&&t.includes(n)),[l,t]),ne=c.useMemo(()=>l.filter(n=>$.find(M=>M.key===n)?.side==="pe"&&t.includes(n)),[l,t]);return N?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx(se,{className:"max-w-md",children:e.jsx(ae,{className:"p-6",children:e.jsxs("div",{className:"text-center text-red-500",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Error Loading Option Chain"}),e.jsx("p",{children:N}),e.jsxs(z,{onClick:R,className:"mt-4",children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"Retry"]})]})})})}):e.jsxs("div",{className:"py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(it,{className:"h-6 w-6"}),e.jsx("h1",{className:"text-3xl font-bold",children:"Option Chain"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(oe,{value:p,onValueChange:I,children:[e.jsx(de,{className:"w-24",children:e.jsx(ue,{placeholder:"Exchange"})}),e.jsx(me,{children:Ut.map(n=>e.jsx(xe,{value:n.value,children:n.label},n.value))})]}),e.jsxs(oe,{value:o,onValueChange:k,children:[e.jsx(de,{className:"w-36",children:e.jsx(ue,{placeholder:"Select Underlying"})}),e.jsxs(me,{className:"max-h-[300px]",children:[e.jsx("div",{className:"sticky top-0 z-10 bg-background p-2 border-b",children:e.jsx(be,{placeholder:"Search...",className:"h-8",onChange:n=>X(n.target.value),onClick:n=>n.stopPropagation(),value:q})}),B.filter(n=>n.toLowerCase().includes(q.toLowerCase())).map(n=>e.jsx(xe,{value:n,children:n},n))]})]}),e.jsxs(oe,{value:b,onValueChange:m,disabled:g.length===0,children:[e.jsx(de,{className:"w-36",children:e.jsx(ue,{placeholder:"Select Expiry"})}),e.jsx(me,{children:g.map(n=>e.jsx(xe,{value:n,children:n},n))})]}),e.jsxs(oe,{value:String(a),onValueChange:n=>C(Number(n)),children:[e.jsx(de,{className:"w-36",children:e.jsx(ue,{placeholder:"Strike Count"})}),e.jsx(me,{children:Vt.map(n=>e.jsx(xe,{value:String(n.value),children:n.label},n.value))})]}),e.jsx(Pt,{barDataSource:d,barStyle:i,onBarDataSourceChange:r,onBarStyleChange:x}),e.jsx(_t,{visibleColumns:t,onToggleColumn:h,onResetToDefaults:f}),e.jsx(Tt,{columnOrder:l,visibleColumns:t,onReorderColumns:j}),e.jsxs(z,{onClick:R,disabled:!b||_,children:[e.jsx(Me,{className:`h-4 w-4 mr-2 ${_?"animate-spin":""}`}),"Refresh"]})]})]}),v&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(se,{children:e.jsxs(ae,{className:"p-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[o," Spot"]}),e.jsx("div",{className:"text-2xl font-bold text-primary",children:J(v.underlying_ltp)}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Prev Close: ",J(v.underlying_prev_close)]})]})}),e.jsx(se,{children:e.jsxs(ae,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"ATM Strike"}),e.jsx("div",{className:"text-2xl font-bold",children:v.atm_strike}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Expiry: ",v.expiry_date]})]})}),e.jsx(se,{children:e.jsxs(ae,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"PCR"}),e.jsx("div",{className:`text-2xl font-bold ${V>1?"text-green-500":"text-yellow-500"}`,children:V.toFixed(2)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Put/Call Ratio"})]})}),e.jsx(se,{children:e.jsxs(ae,{className:"p-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total OI"}),e.jsxs("div",{className:"text-sm mt-1",children:[e.jsx("span",{className:"text-green-500 font-mono tabular-nums",children:he(ee.ceOi)}),e.jsx("span",{className:"mx-2 text-muted-foreground",children:"|"}),e.jsx("span",{className:"text-red-500 font-mono tabular-nums",children:he(ee.peOi)})]}),e.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden mt-2",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-green-500 to-primary transition-all duration-500",style:{width:ee.ceOi+ee.peOi>0?`${ee.ceOi/(ee.ceOi+ee.peOi)*100}%`:"0%"}})})]})})]}),e.jsx(se,{className:"mt-4",children:e.jsx(ae,{className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-2",children:"Market Sentiment"}),e.jsx("div",{className:`text-3xl font-bold ${$t(H.score)}`,children:Yt(H.score)}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:["Score: ",H.score.toFixed(1),"/10"]})]}),e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-2",children:"Sentiment Scale"}),e.jsxs("div",{className:"flex justify-between text-xs mb-1",children:[e.jsx("span",{className:"text-red-500 font-medium",children:"Strong Sell"}),e.jsx("span",{className:"text-muted-foreground",children:"Neutral"}),e.jsx("span",{className:"text-green-500 font-medium",children:"Strong Buy"})]}),e.jsxs("div",{className:"relative h-4 bg-gray-200 dark:bg-gray-800 rounded-full overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500"}),e.jsx("div",{className:"absolute top-0 bottom-0 w-1 bg-white shadow-lg transition-all duration-500",style:{left:`${(H.score+10)/20*100}%`}})]}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsx("span",{children:"-10"}),e.jsx("span",{children:"0"}),e.jsx("span",{children:"+10"})]})]}),e.jsxs("div",{className:"lg:col-span-2 grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"PCR Sentiment"}),e.jsx("div",{className:`text-sm font-semibold ${V>1.3?"text-green-500":V<.7?"text-red-500":"text-yellow-500"}`,children:V>1.3?"Bullish":V<.7?"Bearish":"Neutral"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Max Pain"}),e.jsx("div",{className:"text-sm font-semibold",children:J(Je(v.chain))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Call Premium"}),e.jsxs("div",{className:`text-sm font-semibold ${H.callPremiumTrend>0?"text-green-500":"text-red-500"}`,children:[H.callPremiumTrend>0?"↑":"↓"," ",Math.abs(H.callPremiumTrend).toFixed(1),"%"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Put Premium"}),e.jsxs("div",{className:`text-sm font-semibold ${H.putPremiumTrend>0?"text-green-500":"text-red-500"}`,children:[H.putPremiumTrend>0?"↑":"↓"," ",Math.abs(H.putPremiumTrend).toFixed(1),"%"]})]})]})]})})}),e.jsx(se,{children:e.jsx(ae,{className:"p-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ft,{className:"w-full table-fixed",children:[e.jsxs(gt,{children:[e.jsxs(we,{className:"bg-muted/30 border-b-0",children:[re.length>0&&e.jsx(ie,{className:"text-center text-green-500 font-bold text-sm border-r border-border",children:"CALLS"}),e.jsx(ie,{className:"text-center w-20 min-w-20"}),ne.length>0&&e.jsx(ie,{className:"text-center text-red-500 font-bold text-sm border-l border-border",children:"PUTS"})]}),e.jsxs(we,{className:"bg-muted/50",children:[re.length>0&&e.jsx(ie,{className:"p-0 border-r border-border",children:e.jsx("div",{className:"flex",children:re.map(n=>{const D=$.find(M=>M.key===n);return e.jsx("div",{className:P("flex-1 px-2 py-2 text-xs font-medium min-w-0",D?.align==="right"&&"text-right",D?.align==="center"&&"text-center",D?.align==="left"&&"text-left"),children:D?.label},n)})})}),e.jsx(ie,{className:"text-center bg-muted/30 text-xs w-20 min-w-20",children:"Strike"}),ne.length>0&&e.jsx(ie,{className:"p-0 border-l border-border",children:e.jsx("div",{className:"flex",children:ne.map(n=>{const D=$.find(M=>M.key===n);return e.jsx("div",{className:P("flex-1 px-2 py-2 text-xs font-medium min-w-0",D?.align==="right"&&"text-right",D?.align==="center"&&"text-center",D?.align==="left"&&"text-left"),children:D?.label},n)})})})]})]}),e.jsx(bt,{children:v.chain.map(n=>e.jsx(Qt,{strike:n,previousStrike:L.current.get(n.strike),maxBarValue:Ne,visibleCeColumns:re,visiblePeColumns:ne,barDataSource:d,barStyle:i,optionExchange:W,onPlaceOrder:K},n.strike))})]})})})}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[A?e.jsx(ct,{className:"h-4 w-4 text-green-500"}):e.jsx(ot,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(Ae,{variant:A?"default":w?"secondary":"destructive",children:Y?"Paused":A?`Streaming ${O} symbols`:w?"Polling":"Disconnected"})]}),e.jsxs("div",{className:"text-xs",children:["Bar: ",d==="oi"?"OI":"Volume"," (",i,")"]})]}),e.jsxs("div",{children:["Last Update: ",F?F.toLocaleTimeString():"-"]})]})]}),!v&&!N&&e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}),e.jsx(Bt,{open:E?.open??!1,onOpenChange:Q,symbol:E?.symbol,exchange:E?.exchange,action:E?.action,quantity:E?.quantity,lotSize:E?.lotSize,tickSize:E?.tickSize,strategy:"OptionChain"})]})}export{ds as default};
